async_slam_toolbox_node:
  ros__parameters:
    use_sim_time: true

    # ROS Frames
    odom_frame: odom
    map_frame: map
    base_frame: base_link
    scan_topic: /scan
    use_map_saver: true
    mode: mapping

    # Core map config
    resolution: 0.05           # 5 cm cells (unchanged)

    # Publish/TF timing (match 25 Hz lidar better)
    transform_publish_period: 0.04   # was 0.02; ~25 Hz is enough and reduces churn
    transform_timeout: 0.20          # was 1.0; enough slack for TF without long waits
    tf_buffer_duration: 30.0         # unchanged
    map_update_interval: 0.50        # was 1.0; smoother RViz/consumers without spam

    # Ranging limits
    min_laser_range: 0.12
    max_laser_range: 6.0

    # Motion gating / throttling - IMPROVED for better scan matching
    throttle_scans: 1
    minimum_travel_distance: 0.05    # CHANGED from 0.01; was too small
    minimum_travel_heading: 0.02     # CHANGED from 0.01; prevent micro-rotations
    minimum_time_interval: 0.0

    # Optional behaviors / UX
    enable_interactive_mode: false
    debug_logging: true              # CHANGED: Enable debug logging
    use_map_saver: true
    map_file_name: ""
    map_start_pose: [0.0, 0.0, 0.0]
    map_start_at_dock: false

    # Covariance scaling
    position_covariance_scale: 1.0
    yaw_covariance_scale: 1.0

    # Matcher
    use_scan_matching: true
    use_scan_barycenter: false
    scan_buffer_size: 15                 # REDUCED from 20; less history for cleaner matching
    scan_buffer_maximum_scan_distance: 8.0   # REDUCED from 10.0; stricter local matching

    # LOOP CLOSURE - MADE MORE RESTRICTIVE
    loop_search_maximum_distance: 2.5        # REDUCED from 4.0; only close loops
    do_loop_closing: true
    loop_match_minimum_chain_size: 15        # INCREASED from 10; require longer consistent matches
    loop_match_maximum_variance_coarse: 1.2  # REDUCED from 2.0; stricter variance tolerance
    loop_match_minimum_response_coarse: 0.4  # INCREASED from 0.25; require stronger response

    # Fine matching thresholds - ADD THESE FOR MORE PRECISION
    loop_match_maximum_variance_fine: 0.8    # NEW: strict fine matching variance
    loop_match_minimum_response_fine: 0.6    # NEW: require very strong fine response

    # Correlation search - TIGHTENED
    correlation_search_space_dimension: 0.3  # REDUCED from 0.5; smaller search window
    correlation_search_space_resolution: 0.01
    correlation_search_space_smear_deviation: 0.05  # REDUCED from 0.1; less smoothing

    # Loop search space - MORE RESTRICTIVE
    loop_search_space_dimension: 6.0        # REDUCED from 10.0; much smaller search area
    loop_search_space_resolution: 0.03      # FINER from 0.05; more precise search
    loop_search_space_smear_deviation: 0.05 # REDUCED from 0.1; less smoothing

    # Penalties - INCREASED for stricter matching
    distance_variance_penalty: 0.8          # INCREASED from 0.3; penalize distance variance more
    angle_variance_penalty: 2.5             # INCREASED from 1.5; penalize angle variance more

    # Additional restrictive parameters
    minimum_response_coarse: 0.45           # NEW: minimum coarse response threshold
    minimum_response_fine: 0.65             # NEW: minimum fine response threshold
    
    fine_search_angle_offset: 0.002         # REDUCED from 0.003; finer angle search
    coarse_search_angle_offset: 0.03        # REDUCED from 0.05; finer coarse search
    coarse_angle_resolution: 0.005          # FINER from 0.01; more precise angle resolution
    minimum_angle_penalty: 0.1              # INCREASED from 0.0; penalize angle differences
    minimum_distance_penalty: 0.05          # INCREASED from 0.0; penalize distance differences
    use_response_expansion: false           # DISABLED; be more conservative

    # Occupancy filter
    min_pass_through: 2                     # INCREASED from 0; require multiple confirmations
    occupancy_threshold: 0.08               # INCREASED from 0.05; stricter occupancy

    # Serialization helper
    stack_size_to_use: 40000000